!function(){devise.define("dvsTemplates",["jquery","handlebars"],function(e,t){var i={JST:{}};return i.make=function(e,i){if("undefined"==typeof this.JST[e]&&this.register(e),"undefined"==typeof this.JST[e])throw e+" is not a registered template!";return"function"!=typeof this.JST[e]&&(this.JST[e]=t.compile(this.JST[e])),this.JST[e](i)},i.register=function(t){var i=e('script[id="'+t+'"]').html();this.JST[t]=i},t.registerHelper("when",function(e,t,i){return e&&"0"!=e&&"false"!=e?t:"string"!=typeof i?"":i}),t.registerHelper("get",function(e,t){return e?e:t}),t.registerHelper("date",function(e,t){var i=new Date;return"undefined"!=typeof e&&"now"!==e&&""!==e&&0!=e&&(i=new Date(e)),("undefined"==typeof t||""===t)&&(t="m/d/Y"),i.dateFormat(t)}),t.registerHelper("datetime",function(e,t){var i=new Date;return"undefined"!=typeof e&&"now"!==e&&""!==e&&0!=e&&(i=new Date(e)),("undefined"==typeof t||""===t)&&(t="m/d/Y h:i A"),i.dateFormat(t)}),t.registerHelper("select",function(e,t,i){return"undefined"==typeof i?i=t:e||(e=t),i.fn(this).split("\n").map(function(t){var i='value="'+e+'"';return RegExp(i).test(t)?t.replace(i,i+' selected="selected"'):t}).join("\n")}),t.registerHelper("ifType",function(e,t,i){return typeof e===t?i.fn(this):i.inverse(this)}),t.registerHelper("checked",function(e,t){return e&&"0"!=e&&"false"!=e?"checked":""}),t.registerHelper("disabled",function(e,t){return e&&"0"!=e&&"false"!=e?"disabled":""}),t.registerHelper("script",function(e){return e.fn?"<script>"+e.fn(this)+"</script>":e.hash.src?(console.log(e.hash.src),'<script src="'+e.hash.src+'"></script>'):void 0}),i}),devise.define("dvsEditor",["jquery","query","dvsSidebarView","dvsBaseView","dvsPositionHelper","dvsSelectSurrogate","dvsLiveUpdater","BindingsFinder"],function(e,t,i,n,s,a,r,o){function d(i){var n=i.iframeView;n.load(function(){var t=this.contentWindow;setTimeout(function(){var s=t.location.href;if(-1===s.indexOf("start-editor=false"))return void(window.location.href=s);n.contents().find("a").each(function(t,i){var n=e(this).attr("target");("undefined"==typeof n||"_self"==n)&&e(i).attr("target","_top")});var a=n.contents().find("body");a.on("submit","form",function(t){e(t.currentTarget).hasClass("dvs-allow-submit")||t.preventDefault()}),i.showingSidebar&&a.addClass("dvs-sidebar-mode"),i.showingEditor&&a.addClass("dvs-node-mode"),i.updateData(t.dvsPageData),i.csrf(i.data.csrfToken),i.finder=new o(i.data.database),i.bindings=i.finder.find(l(t.document.childNodes)),i.bindings.apply(),a.append(i.createNodesView()),i.iframeBodyView=a,i.nodesView=a.find("#dvs-nodes"),i.recalculateNodePositions(),r.setup(n,i.bindings,i.data.database)})});var s=location.origin;window.location.origin||(s=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")),n.attr("src",t.append("start-editor","false",s+location.pathname+location.search)+location.hash)}function l(e){for(var t=0;t<e.length;t++)if(1===e[t].nodeType)return e[t];return null}function h(e){this.layoutView.hasClass("dvs-node-mode")?this.hideEditor():this.showEditor()}function c(e){this.hideSidebar(),this.showEditor()}function u(e){this.aboutPageButtonView.toggleClass("open"),this.aboutPageContainerView.toggleClass("open")}function p(t){e(t.currentTarget).siblings(".about-var-dump").toggleClass("open")}var f={"click #dvs-node-mode-button":h,"click #dvs-about-page-button":u,"click #dvs-about-page-container h5":p,"click .dvs-sidebar-close":c},v=function(e,t,n){this.events=f,this.csrf=n,this.sidebar=new i(t),this.updateData(t)};return v.prototype.updateData=function(e){this.pageId=e.pageId,this.pageVersionId=e.pageVersionId,this.data=e,this.sidebar.page=e},v.prototype.start=function(){return this.shouldStart()?(this.removeParentStyles(),this.render(),n.registerEvents(this.layoutView,this.events,this),e("body").show(),!0):!1},v.prototype.removeParentStyles=function(){e('link[rel="stylesheet"], style').each(function(t,i){var n=e(i);"undefined"==typeof n.data("deviseEditorAsset")&&n.remove()})},v.prototype.render=function(){this.layoutView=e("#dvs-mode"),this.iframeView=this.layoutView.find("#dvs-iframe"),this.nodesView=e("<div/>"),this.iframeBodyView=e("<div/>"),this.editButtonView=this.layoutView.find("#dvs-node-mode-button"),this.aboutPageButtonView=this.layoutView.find("#dvs-about-page-button"),this.aboutPageContainerView=this.layoutView.find("#dvs-about-page-container"),this.sidebarContainerView=this.layoutView.find("#dvs-sidebar-container"),this.sidebarView=this.layoutView.find("#dvs-sidebar"),d(this),this.aboutPageContainerView.empty(),this.aboutPageContainerView.append(n.make("about-page"))},v.prototype.createNodesView=function(){var t=e('<div id="dvs-nodes" style="width: 100%; position: absolute; top: 0px; left: 0px;"; class="dvs-faded"></div>'),i=this;return e.each(this.data.nodes,function(e,i){var s=n.make("editor.node",{id:i.cid+"-node",cid:e,node:i});1==i.data.content_requested&&s.addClass("dvs-content-requested"),t.append(s)}),t.on("click","[data-node-cid]",function(t){var n=e(t.currentTarget).data("node-cid");i.showSidebar(n)}),t},v.prototype.shouldStart=function(){return-1===location.href.indexOf("start-editor=false")&&-1===location.href.indexOf("disable-editor")},v.prototype.showEditor=function(){this.layoutView.addClass("dvs-node-mode"),this.iframeBodyView.addClass("dvs-node-mode"),this.showingEditor=!0,this.nodesView.show()},v.prototype.hideEditor=function(){this.nodesView.hide(),this.showingEditor=!1,this.layoutView.removeClass("dvs-node-mode"),this.iframeBodyView.removeClass("dvs-node-mode")},v.prototype.showSidebar=function(e){var t=this.data.nodes[e];this.hideEditor(),this.showingSidebar=!0,this.sidebarView.empty(),this.sidebarView.append(this.sidebar.render(t)),this.sidebarView.addClass("loaded"),this.layoutView.addClass("dvs-sidebar-mode"),this.iframeBodyView.addClass("dvs-sidebar-mode"),this.sidebarContainerView.show(),this.sidebarRendered(t)},v.prototype.sidebarRendered=function(e){a()},v.prototype.hideSidebar=function(){this.showingSidebar=!1,this.sidebar.close(),this.sidebarContainerView.hide(),this.sidebarView.removeClass("loaded"),this.layoutView.removeClass("dvs-sidebar-mode"),this.iframeBodyView.removeClass("dvs-sidebar-mode"),this.sidebarView.empty(),this.showEditor()},v.prototype.recalculateNodePositions=function(){s.recalculateNodePositions(this.nodesView,this.data.nodes)},v}),devise.define("query",["jquery"],function(e){var t={};return t.toJson=function(e){"undefined"==typeof e&&(e=window.location.search.substr(1));var t=e.split("&"),i={};if(""==t)return{};for(var n=0;n<t.length;++n){var s=t[n].split("=",2);1==s.length?i[s[0]]="":i[s[0]]=decodeURIComponent(s[1].replace(/\+/g," "))}return i},t.toQueryString=function(t){"undefined"==typeof t&&(t={});var i="";return e.each(t,function(e,t){i+="&"+e+"="+encodeURIComponent(t)}),i.replace("&","?")},t.get=function(e,t){t="undefined"==typeof t?null:t,e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var i=new RegExp("[\\?&]"+e+"=([^&#]*)"),n=i.exec(location.search);return null==n?t:decodeURIComponent(n[1].replace(/\+/g," "))},t.append=function(e,t,i){var n=-1===i.indexOf("?")?"?":"&";return i+n+e+"="+encodeURIComponent(t)},t}),devise.define("dvsCsrf",["jquery"],function(e){function t(t){e.ajaxSetup({headers:{"X-XSRF-TOKEN":t}})}var i=e('meta[name="csrf-token"]').attr("content");return i&&t(i),t}),devise.define("dvsSidebarView",["jquery","query","dvsBaseView","dvsFieldView","dvsCollectionView","dvsModelView","dvsAttributeView","dvsCreatorView","dvsGroupView","dvsBreadCrumbsView","jqSerializeObject"],function(e,t,i,n,s,a,r,o,d,l){function h(t){var i=e(t.currentTarget).val();this.changePageVersion(i)}function c(e){var t=prompt("What would you like to name this new page version?");t&&this.addPageVersion(t)}function u(t){var i=e(t.currentTarget).find(":selected").data("url"),n=e(t.currentTarget).val();n!=this.page.languageId&&(location.href=i)}var p={"change #dvs-sidebar-version-selector":h,"click #dvs-sidebar-add-version":c,"change #dvs-language-selector":u,"click .dvs-sidebar-save-group":"save","input form [name]":"changed","change form [name]":"changed"},f=function(e){this.page=e,this.contentView=null,this.breadcrumbsView=null,this.layout=null,this.title=null,this.languageSelector=null,this.versionsSelector=null,this.groupSelector=null,this.datePickers=null,this.breadcrumbs=null,this.grid=null,this.manageCollection=null,this.validationErrors=null,this.content=null,this.saveButton=null,this.saveNotification=null};return f.prototype.render=function(e){return this.contentView=this.createViewFromBinding(e.binding),this.breadcrumbsView=new l,this.layout=i.make("sidebar.layout",{page:this.page,node:e}),this.title=this.layout.find('[data-view="sidebar-title"]'),this.languageSelector=this.layout.find('[data-view="language-selector"]'),this.versionsSelector=this.layout.find('[data-view="versions-selector"]'),this.groupSelector=this.layout.find('[data-view="group-selector"]'),this.datePickers=this.layout.find('[data-view="date-pickers"]'),this.breadcrumbs=this.layout.filter('[data-view="breadcrumbs"]'),this.grid=this.layout.filter('[data-view="grid"]'),this.manageCollection=this.layout.filter('[data-view="manage-collection"]'),this.validationErrors=this.layout.filter('[data-view="validation-errors"]'),this.content=this.layout.find('[data-view="content"]'),this.saveButton=this.layout.find('[data-view="save-button"]'),this.saveNotification=this.layout.find('[data-view="save-notification"]'),this.saveButton.hide(),this.breadcrumbsView.setContainerElement(this.breadcrumbs),this.content.append(this.contentView.render(e)),this.languageSelector.append(i.make("sidebar.partials.language-selector",{page:this.page})),this.versionsSelector.append(i.make("sidebar.partials.versions-selector",{page:this.page})),this.datePickers.append(i.make("sidebar.partials.date-pickers",{page:this.page})),i.registerEvents(this.layout,p,this),this.layout},f.prototype.close=function(){this.contentView.close(),this.contentView=null,this.breadcrumbsView=null,this.layout=null,this.title=null,this.languageSelector=null,this.versionsSelector=null,this.datePickers=null,this.breadcrumbs=null,this.manageCollection=null,this.content=null,this.saveButton=null},f.prototype.changePageVersion=function(e){if(e!=this.page.pageVersionId){var n=t.toJson(),s=i.data.find(this.page.pageVersions,e);n.page_version=s.name,location.href=location.origin+location.pathname+t.toQueryString(n)}},f.prototype.addPageVersion=function(t){var i={page_version_id:this.page.pageVersionId,name:t};e.post("/admin/page-versions",i).then(function(e,t,i){var n=window.location.origin;n+=window.location.pathname,n+="?page_version="+e.name,window.location.href=n})},f.prototype.save=function(e){var t=this.layout.find("form"),i=t.serializeObject();this.contentView.save(i,e)},f.prototype.changed=function(t){var i=e(t.currentTarget),n=i.attr("name"),s=i.val(),a=i.attr("type");switch("checkbox"===a&&(s=i.is(":checked")?s:!1),n){case"content_requested":"function"==typeof this.contentView.contentRequestedChanged&&this.contentView.contentRequestedChanged(s,t);break;case"field_scope":"function"==typeof this.contentView.fieldScopeChanged&&this.contentView.fieldScopeChanged(s,t);break;case"_reset_values":"function"==typeof this.contentView.resetValuesChanged&&this.contentView.resetValuesChanged(s,t);break;default:this.contentView.changed(n,s,t)}},f.prototype.createViewFromBinding=function(e){switch(e){case"field":return new n(this);case"collection":return new s(this);case"model":return new a(this);case"attribute":return new r(this);case"group":return new d(this);case"creator":return new o(this)}throw"could not find type of view: "+e},f}),devise.define("dvsBaseView",["jquery","dvsTemplates"],function(e,t){var i={data:{}};return i.registerEvents=function(t,i,n){e.each(i,function(e,i){var s=e.split(" "),a=s.shift(),r=s.join(" "),o="string"==typeof i?n[i]:i;if("function"!=typeof o)throw"invalid handler given: "+i;t.on(a,r,function(){o.apply(n,arguments)})})},i.make=function(e,n){var e=t.make(e,n);return i.compile(e)},i.compile=function(t){return e("<div/>").html(t).contents()},i.render=function(e,i){return t.make(e,i)},i.data.filter=function(t,i){var n=[];return e.each(t,function(t,s){var a=!0;e.each(i,function(e,t){return"undefined"==typeof s[e]||s[e]!=t?(a=!1,!1):void 0}),a&&n.push(s)}),n},i.data.find=function(t,i){var n=null;return e.each(t,function(e,t){return t.id==i?(n=t,!1):void 0}),n},i.data.findIndex=function(t,i){var n=-1;return e.each(t,function(e,t){return t.id==i?(n=e,!1):void 0}),n},i}),devise.define("dvsPositionHelper",["jquery"],function(e){function t(e){p=e.children().first().children(".dvs-node-inner-wrapper").height()}function i(t,i){t.children().each(function(n,a){var r=e(a).data("node-cid"),o=i[r],l=t.closest("body");if("group"===o.binding)for(var h=0;h<o.data.length;h++){console.log("here");var c=o.data[h];c.position=s(c,l)}o.position=s(o,l),o.position.side=d(o.position)})}function n(t,i){t.children().each(function(t,n){var s=e(n),a=s.data("node-cid"),r=i[a];s.css("top",r.position.top),s.removeClass("left right"),s.addClass(r.position.side)})}function s(e,t){return"group"===e.binding?o(e,t):"collection"===e.binding?a(e,t):r(e.key,e.cid,t)}function a(e,t){var i,n,s=t.find('[data-dvs-placeholder^="'+e.key+'["]').last(),a=t.find("[data-devise-"+e.cid+"]").first();return a.length?(i=!a.is(":visible"),i&&a.show(),n=a.offset(),i&&a.hide(),"object"==typeof n&&n.top?n:c(a)):(s.show(),n=s.offset(),s.hide(),"object"==typeof n&&n.top?n:c(s))}function r(e,t,i){var n,s,a=i.find('[data-dvs-placeholder="'+e+'"]').last(),r=i.find("[data-devise-"+t+"]").first();return r.length?(n=!r.is(":visible"),n&&r.show(),s=r.offset(),n&&r.hide(),"object"==typeof s&&s.top?s:c(r)):(a.show(),s=a.offset(),a.hide(),"object"==typeof s&&s.top?s:c(a))}function o(t,i){var n=!1,a=0,r=0,o=0,d=0;return e.each(t.data.categories,function(e,t){for(var l=0;l<t.nodes.length;l++){var h=t.nodes[l],c=s(h,i);0!=c.left&&(r+=c.left,d++),0!=c.top&&(a+=c.top,o++)}n=c,n.top=a/o,n.left=r/d}),n}function d(t){var i=e(window).width()/2;return"undefined"==typeof t?"float":t.left>i?"right":"left"}function l(e,t){for(var i=t,n=(e.closest("body"),0);n<i.length;n++)for(var s=0;s<i.length;s++)n!=s&&h(i[n],i[s])&&(i[n].position.top+=p,s=0)}function h(e,t){return e.position.side!=t.position.side?!1:Math.abs(e.position.top-t.position.top)<p}function c(e){for(var t,i=50,n=e,s=e.parent();n!==s&&i--;){if(t=s.offset(),"object"==typeof t&&t.top)return t;n=s,s=n.parent()}return{top:0,left:0}}function u(){e("#dvs-iframe").contents().find("[data-dvs-placeholder]").remove()}var p=40;return{recalculateNodePositions:function(e,s){t(e),i(e,s),l(e,s),n(e,s),u()}}}),devise.define("dvsSelectSurrogate",["require","jquery"],function(e,t){function i(e){t.each(e,function(e,i){if(0===t(this).parents(".dvs-select-wrapper").length){t(this).removeClass("dvs-select");var s=t(this).attr("class");t(this).wrap("<span class='dvs-select-wrapper "+s+"'></span>"),t(this).after("<span class='dvs-holder'></span>"),n(this)}})}function n(e){t(e).on("change",function(){var e=t(this).find(":selected").text();t(this).next(".dvs-holder").text(e)}).trigger("change")}var s=function(){var e=t(".dvs-select");i(e)};return s}),devise.define("dvsLiveUpdater",["dvsLiveUpdate"],function(e){return new e}),devise.define("BindingsFinder",["AttributeBinding","ClassBinding","StyleBinding","TextBinding"],function(e,t,i,n){function s(e,t,i){t=o(e,t,i),t=d(e,t,i);for(var n=0;n<e.childNodes.length;n++)t=s(e.childNodes[n],t,i);return t}function a(e){return e.apply=function(t){for(var i in e)"apply"!==i&&"function"==typeof e[i].apply&&(t?e[i].key===t&&e[i].apply():e[i].apply())},e}function r(e){var t=e.substring(3,e.length-3).split("-");t.shift();return t.join("-")}function o(i,n,s){if(i.nodeType!==i.ELEMENT_NODE||i.__magicAlreadyDone)return n;for(var a=0;a<i.attributes.length;a++)for(var o=i.attributes[a],d=o.nodeValue.match(s.pattern),l=d&&d.length||0,h=0;l>h;h++){var u=r(d[h]);"style"===o.name?n=c(i,n,d[h],s.lookup):"class"===o.name?n.push(new t(i,u,s.lookup,d[h])):n.push(new e(o,u,s.lookup))}return n}function d(e,t,i){if(e.nodeType!==e.TEXT_NODE||e.__magicAlreadyDone)return t;var s=e.nodeValue.match(i.pattern),a=s&&s.length||0;if(0===a)return t;for(var o=l(e,s),d=0;d<o.length;d++){var h=document.createTextNode(o[d]),c=s.indexOf(o[d]);if(c>-1){var u=r(s[c]);t.push(new n(h,u,i.lookup,s[c]))}h.__magicAlreadyDone=!0,e.parentNode.insertBefore(h,e)}return e.parentNode.removeChild(e),t}function l(e,t){for(var i=e.nodeValue,n=[i],s=0;s<t.length;s++)n=h(n,t[s]);return n}function h(e,t){for(var i=[],n=0;n<e.length;n++){var s=e[n],a=s.indexOf(t),r=t.length,o=s.substr(0,a),d=s.substr(a+r);-1!==a?(0!==o.length&&i.push(o),i.push(t),0!==d.length&&i.push(d)):i.push(s)}return i}function c(e,t,n,s){for(var a=e.attributes.getNamedItem("style").nodeValue.split(";"),o=u(a,n),d=r(n),l=0;l<o.length;l++)t.push(new i(e,d,s,n,o[l].style,o[l].value));return t}function u(e,t){for(var i=[],n=0;n<e.length;n++){var s=e[n],a=s.split(":"),r="undefined"==typeof a[0]?null:a[0],o="undefined"==typeof a[1]?null:a[1];o&&r&&-1!==o.indexOf(t)&&i.push({style:p(r.trim()),value:o.trim()})}return i}function p(e){for(var t=e.split("-"),i=t.length-1;i>0;i--)t[i]=t[i].substr(0,1).toUpperCase()+t[i].substr(1);return t.join("")}var f=function(e,t){return"undefined"==typeof t[e]?"":t[e]},v=function(e,t,i){i[e]=t},g=function(e,t,i){t="function"!=typeof t?f:t,i="function"!=typeof i?v:i,this.pattern=new RegExp("###dvsmagic-[^###]+###","g"),this.models=e,this.lookup=function(i){return t(i,e)},this.setter=function(t,n){return t?i(t,n,e):void 0}};return g.prototype.find=function(e){var t=[];return t=a(t),t.get=this.lookup,t.set=this.setter,t=s(e,t,this)},g}),devise.define("dvsFieldView",["jquery","dvsBaseView","dvsLiveUpdater"],function(e,t,i){function n(e,t,n){this.data.node.data=e,this.data.node.data.originals=this.originals,this.data.field=this.data.node.data,this.view.empty(),this.view.append(this.renderField(this.data.field,!0)),this.sidebar.layout.removeClass("saving"),i.changedField(this.data.field)}function s(){alert("Could not save field! Check console"),console.warn("save error",this,arguments),this.sidebar.layout.removeClass("saving")}var a={},r=function(e){this.sidebar=e,this.data={page:e.page},this.view=null,this.loadDefaults=!0};return r.prototype.render=function(i){return this.data.node=i,this.view=e("<div/>"),this.view.append(this.renderField(i.data,!0)),this.sidebar.breadcrumbsView.add(i.human_name,this,"renderField",[i.data,!0]),this.sidebar.saveButton.show(),t.registerEvents(this.view,a,this),this.view},r.prototype.renderField=function(e,n){var s=t.make("sidebar.partials.request-content",{content_requested:e.content_requested}),a=t.make("sidebar.partials.reset-values"),r=t.make("sidebar.partials.site-wide-field",{site_wide:"global"===e.scope});this.data.field=e,this.loadDefaults===!0&&i.setDefaultsForField(this.data.field);var o=t.make("sidebar.fields."+e.type,{page:this.data.page,field:e,values:e.values});return o.find('[data-view="content-requested"]').replaceWith(s),o.find('[data-view="reset-values"]').replaceWith(a),n&&o.find('[data-view="site-wide-field"]').replaceWith(r),o},r.prototype.close=function(){this.sidebar=null,this.data=null,this.view=null},r.prototype.save=function(t){this.data.field.values=t,this.originals||(this.originals={},this.originals.id=this.data.field.id,this.originals.scope=this.data.field.scope);var i=this,a=this.data.page.url("update_field",{id:this.data.field.id}),r={field:this.data.field,page:this.data.page.info};this.sidebar.layout.addClass("saving"),e.ajax(a,{method:"PUT",data:r,success:function(){n.apply(i,arguments)},error:function(){s.apply(i,arguments)}})},r.prototype.changed=function(e,t,n){this.data.field.values[e]=t,i.changedFieldAttribute(this.data.field,e)},r.prototype.contentRequestedChanged=function(e){this.data.field.content_requested=e},r.prototype.fieldScopeChanged=function(e){this.data.field.new_scope=e?"global":"page"},r.prototype.resetValuesChanged=function(t){if(t){var i=this;if(window.confirm("Are you sure you want to reset all values for this field? This will save immediately.")){var n=i.data.field,s=i.data.page.url("reset_field",{id:n.id,scope:n.scope});e.post(s),setTimeout(function(){n.values={},i.view.empty(),i.loadDefaults=!1,i.view.append(i.renderField(n,!0)),i.loadDefaults=!0},500)}else i.view.find("#_reset_values").prop("checked",!1)}},r}),devise.define("dvsCollectionView",["jquery","dvsBaseView","dvsFieldView","dvsSelectSurrogate","dvsLiveUpdater","jquery-ui"],function(e,t,i,n,s){function a(e){!this.showingManageView&&this.sidebar.breadcrumbsView.add("Collections",this,"renderManageView"),this.showingManageView=!0,this.renderManageView()}function r(t){var i=e(t.currentTarget),n=i.val();n&&this.selectedInstanceId!=n&&(this.setSelectedInstanceId(n),this.showingManageView||this.showingFieldView?this.sidebar.breadcrumbsView.back():this.renderGridView())}function o(i){var n=e(i.currentTarget),s=n.data("showField");this.showingFieldView=!0,this.selectedField=t.data.find(this.selectedInstance.fields,s),this.sidebar.breadcrumbsView.add(this.selectedField.human_name,this,"renderCollectionField"),this.renderCollectionField()}function d(i){var n=this,s=i.currentTarget.dataset.removeInstanceId,a=t.data.findIndex(this.data.instances,s),r=(t.data.find(this.data.instances,s),this.data.page.url("remove_collection_instance",{id:s,collectionId:this.data.collection.id})),o=(this.manage.find("#dvs-new-collection-instance-name"),{});this.sidebar.layout.addClass("saving"),e.ajax(r,{method:"POST",data:o,success:function(){n.sidebar.layout.removeClass("saving"),n.data.instances.splice(a,1),n.renderInstanceSelectorView(),n.renderManageView(),n.manage.find("#dvs-new-collection-instance-name").focus()},error:function(){alert("could not remove instance at this time"),console.warn("could not remove instance at this time",arguments),n.sidebar.layout.removeClass("saving"),n.manage.find("#dvs-new-collection-instance-name").focus()}})}function l(t){var i=this,n=e(t.currentTarget),s=n.parent().find("#dvs-new-collection-instance-name"),a=s.val(),r=this.createNewInstance(a),o=this.data.instances.length,d=this.data.page.url("add_collection_instance",{pageVersionId:this.data.page.info.page_version_id,collectionId:this.data.collection.id});a&&(s.val(""),this.data.instances[o]=r,this.renderManageView(),this.sidebar.layout.addClass("saving"),e.ajax(d,{method:"POST",data:r,success:function(e){i.sidebar.layout.removeClass("saving"),i.data.instances[o]=e,i.renderInstanceSelectorView(),i.renderManageView(),i.manage.find("#dvs-new-collection-instance-name").focus()},error:function(){alert("could not add instance at this time"),console.warn("could not add instance at this time",arguments),i.sidebar.layout.removeClass("saving"),i.data.instances.splice(o,1),i.renderManageView(),i.manage.find("#dvs-new-collection-instance-name").focus()}}))}function h(t){var i=this,n=[],s=this.data.page.url("sort_collection_instance",{pageVersionId:this.data.page.info.page_version_id,collectionId:this.data.collection.id}),a=this.manage.filter("#dvs-collection-instances-sortable");a.children().each(function(e,t){n.push(t.dataset.instanceId)}),e.ajax(s,{method:"POST",data:{instances:n},success:function(){i.resortInstances(n),i.renderInstanceSelectorView()},error:function(){alert("could not sort instance"),console.warn("could not sort instance",arguments),i.renderManageView()}})}function c(i){var n=this,s=i.currentTarget.dataset.instanceId,a=i.currentTarget.value,r=this.data.page.url("update_collection_instance",{pageVersionId:this.data.page.info.page_version_id,collectionId:this.data.collection.id,id:s}),o=t.data.find(this.data.instances,s),d=o.name;o.name=a,e.ajax(r,{method:"PUT",data:o,success:function(){n.renderInstanceSelectorView()},error:function(){alert("could not rename instance"),console.warn("could not rename instance",arguments),o.name=d,n.renderManageView()}})}var u={"click #dvs-sidebar-manage-groups":a,"click #dvs-new-collection-instance":l,"change #dvs-groups-select":r,"click [data-show-field]":o,"click [data-remove-instance-id]":d,"change .dvs-collection-instance-name":c},p=function(e){this.sidebar=e,this.data={page:e.page},this.grid=null,this.manage=null,this.instanceSelector=null,this.field=null};return p.prototype.render=function(t){return this.data.node=t,this.data.instances=t.data,this.data.collection=t.collection,this.sidebar.breadcrumbsView.add("All Editors",this,"renderGridAndSelectorViews"),this.field=e("<div/>"),this.manage=e("<div/>"),this.grid=e("<div/>"),this.renderGridAndSelectorViews(),0===this.data.instances.length&&this.renderManageView(),this.field},p.prototype.renderGridAndSelectorViews=function(){this.showingManageView=!1,this.showingFieldView=!1,this.renderInstanceSelectorView(),this.renderGridView()},p.prototype.renderGridView=function(){0!==this.data.instances.length&&(!this.selectedInstanceId&&this.setSelectedInstanceId(this.instanceSelector.find("#dvs-groups-select").val()),this.grid=t.make("sidebar.collections.grid",this.data),this.grid.show(),this.sidebar.grid.empty(),this.sidebar.grid.append(this.grid),this.manage.hide(),this.field.hide(),this.sidebar.saveButton.hide(),t.registerEvents(this.grid,u,this))},p.prototype.renderManageView=function(){var e=this;this.manage=t.make("sidebar.collections.manage",this.data);var i=this.manage.filter("#dvs-collection-instances-sortable").sortable({axis:"y",stop:function(){h.apply(e,arguments)},placeholder:"dvs-sort-placeholder"});i.disableSelection(),this.manage.show(),this.grid.hide(),this.field.hide(),this.sidebar.manageCollection.show(),this.sidebar.manageCollection.empty(),this.sidebar.manageCollection.append(this.manage),t.registerEvents(this.manage,u,this)},p.prototype.renderInstanceSelectorView=function(){this.instanceSelector=t.make("sidebar.collections.selector",{instances:this.data.instances,selectedInstanceId:this.selectedInstanceId}),this.sidebar.groupSelector.empty(),this.sidebar.groupSelector.append(this.instanceSelector),this.selectedInstanceId=!1,n(),t.registerEvents(this.instanceSelector,u,this)},p.prototype.renderCollectionField=function(){var e=new i(this.sidebar);e.loadDefaults=!1;var t=e.renderField(this.selectedField);this.field.empty(),this.field.append(t),this.field.show(),this.manage.hide(),this.grid.hide(),this.sidebar.saveButton.show(),n()},p.prototype.close=function(){this.grid=null,this.manage=null,this.instanceSelector=null,this.field=null},p.prototype.setSelectedInstanceId=function(i){this.selectedInstanceId=i,this.selectedInstance=t.data.find(this.data.instances,i),e.each(this.data.instances,function(e,t){t.id==i?t.active="dvs-active":t.active=!1})},p.prototype.save=function(t){this.selectedField.values=t;var i=this,n=this.data.page.url("update_collection_field",{id:this.selectedField.id}),a={field:this.selectedField,page:this.data.page.info};this.sidebar.layout.addClass("saving"),e.ajax(n,{method:"PUT",data:a,success:function(e,t,n){i.sidebar.layout.removeClass("saving"),i.selectedField=e,i.renderCollectionField(),s.changedField(i.selectedField)},error:function(e,t,n){alert("Could not save field! Check console"),console.warn("save error",arguments),i.sidebar.layout.removeClass("saving")}})},p.prototype.changed=function(e,t,i){this.selectedField.values[e]=t,s.changedFieldAttribute(this.selectedField,e)},p.prototype.resetValuesChanged=function(e,t){if(e){var i=this;this.selectedField.values={},setTimeout(function(){i.renderCollectionField()},500)}},p.prototype.contentRequestedChanged=function(e){this.selectedField.content_requested=e},p.prototype.createNewInstance=function(t){var i=this,n={};return n.id="new"+this.data.instances.length,n.collection_set_id=this.data.node.collection.id,n.page_version_id=this.data.page.info.page_version_id,n.name=t,n.sort=this.data.instances.length,n.fields=[],e.each(this.data.node.schema,function(e,t){n.fields.push({collection_instance_id:"new"+i.data.instances.length,page_version_id:i.data.page.info.page_version_id,type:t.type,human_name:t.humanName,key:t.key,json_value:"{}",values:{}})}),n},p.prototype.resortInstances=function(e){for(var i=[],n=0;n<e.length;n++){var s=e[n],a=t.data.find(this.data.instances,s);a.sort=n,i.push(a)}this.data.instances=i},p}),devise.define("dvsModelView",["jquery","dvsBaseView","dvsFieldView","dvsLiveUpdater"],function(e,t,i,n){function s(e,t,i){this.sidebar.layout.removeClass("saving"),this.data.fields=e.fields,this.sidebar.breadcrumbsView.back(),this.renderGridView(),this.showGridView(),n.changedModel(this.data.field)}function a(e,i,n){if(403!==e.status)return console.warn("save error",e,i,n),void alert("Could not save field due to unknown error.");var s=t.make("sidebar.partials.errors",{errors:e.responseJSON.errors});this.sidebar.layout.removeClass("saving"),this.sidebar.validationErrors.empty(),this.sidebar.validationErrors.append(s),this.sidebar.breadcrumbsView.back(),this.showGridView()}function r(e){var t=e.currentTarget.dataset.modelFieldId;this.showModelFieldView(t)}var o={"click [data-model-field-id]":r},d=function(e){this.sidebar=e,this.data={page:e.page},this.grid=null,this.field=null};return d.prototype.render=function(t){return this.data.node=t,this.data.fields=t.data,this.data.model=t.model,this.field=e("<div/>"),this.renderGridView(),this.sidebar.breadcrumbsView.add(t.human_name,this,"showGridView"),this.field},d.prototype.close=function(){this.data=null,this.grid=null,this.field=null},d.prototype.showModelFieldView=function(e){var t=this.renderModelField(e);this.sidebar.breadcrumbsView.add(this.data.field.mapping,this,"showModelFieldView",[e]),this.field.empty(),this.field.append(t),this.field.show(),this.grid.hide(),this.sidebar.saveButton.show()},d.prototype.showValidationErrorsView=function(e){var i=t.make("sidebar.partials.errors",{errors:e});this.sidebar.validationErrors.empty(),this.sidebar.validationErrors.append(i)},d.prototype.renderModelField=function(e){var n=new i(this.sidebar),s=t.data.find(this.data.fields,e),a=n.renderField(s);return this.data.field=s,a},d.prototype.showGridView=function(){this.field.empty(),this.grid.show(),this.sidebar.saveButton.hide()},d.prototype.save=function(t){this.data.field.values=t;var i=this,n=this.data.page.url("update_model_fields"),r={fields:this.data.fields,page:this.data.page.info};this.sidebar.layout.addClass("saving"),this.sidebar.validationErrors.empty(),e.ajax(n,{method:"PUT",data:r,success:function(){s.apply(i,arguments)},error:function(){a.apply(i,arguments)}})},d.prototype.changed=function(e,t,i){this.data.field.values[e]=t,n.changedModelAttribute(this.data.field,e)},d.prototype.contentRequestedChanged=function(e){this.data.field.content_requested=e},d.prototype.resetValuesChanged=function(e){if(e){var t=this,i=this.data.field;setTimeout(function(){i.values={},t.field.empty(),t.field.append(t.renderModelField(i.id))},500)}},d.prototype.renderGridView=function(){this.grid=t.make("sidebar.models.grid",this.data),this.sidebar.grid.empty(),this.sidebar.grid.append(this.grid),t.registerEvents(this.grid,o,this)},d}),devise.define("dvsAttributeView",["jquery","dvsBaseView","dvsFieldView","dvsLiveUpdater"],function(e,t,i,n){function s(e,t,i){this.sidebar.layout.removeClass("saving"),this.data.field=e.field,n.changedModel(this.data.field)}function a(e,i,n){if(403!==e.status)return console.warn("save error",e,i,n),void alert("Could not save field due to unknown error.");var s=t.make("sidebar.partials.errors",{errors:e.responseJSON.errors});this.sidebar.layout.removeClass("saving"),this.sidebar.validationErrors.empty(),this.sidebar.validationErrors.append(s)}var r={},o=function(e){this.sidebar=e,this.data={page:e.page},this.view=null,this.fieldView=null};return o.prototype.render=function(n){return this.data.node=n,this.data.field=n.data,this.data.model=n.model,this.fieldView=new i(this.sidebar),this.view=e("<div/>"),this.renderField(),this.sidebar.breadcrumbsView.add(n.human_name,this,"renderField"),
t.registerEvents(this.view,r,this),this.view},o.prototype.renderField=function(){this.view.empty(),this.view.append(this.fieldView.renderField(this.data.field)),this.sidebar.saveButton.show()},o.prototype.close=function(){this.sidebar=null,this.data=null,this.view=null,this.fieldView=null},o.prototype.save=function(t){this.data.field.values=t;var i=this,n=this.data.page.url("update_model_attribute",{id:this.data.field.id}),r={field:this.data.field,page:this.data.page.info};this.sidebar.validationErrors.empty(),this.sidebar.layout.addClass("saving"),e.ajax(n,{method:"PUT",data:r,success:function(){s.apply(i,arguments)},error:function(){a.apply(i,arguments)}})},o.prototype.changed=function(e,t,i){this.data.field.values[e]=t,n.changedModelAttribute(this.data.field,e)},o.prototype.contentRequestedChanged=function(e){this.data.field.content_requested=e},o.prototype.resetValuesChanged=function(e){if(e){var t=this;setTimeout(function(){t.data.field.values={},t.renderField()},500)}},o}),devise.define("dvsCreatorView",["jquery","dvsBaseView","dvsFieldView","dvsLiveUpdater"],function(e,t,i,n){function s(e,t,i){this.createDefaultFields(this.data.creator),this.sidebar.breadcrumbsView.back(),this.sidebar.layout.removeClass("saving"),this.showGridView()}function a(e,i,n){if(403!==e.status)return console.warn("save error",e,i,n),void alert("Could not save field due to unknown error.");var s=t.make("sidebar.partials.errors",{errors:e.responseJSON.errors});this.sidebar.layout.removeClass("saving"),this.sidebar.validationErrors.empty(),this.sidebar.validationErrors.append(s),this.sidebar.breadcrumbsView.back(),this.showGridView()}function r(e){var t=e.currentTarget.dataset.creatorAttributeName;this.showFieldView(t)}var o={"click [data-creator-attribute-name]":r},d=function(e){this.sidebar=e,this.data={page:e.page,attributes:{}},this.grid=null,this.field=null};return d.prototype.render=function(i){return this.data.node=i,this.data.creator=i.data,this.createDefaultFields(this.data.creator),this.field=e("<div/>"),this.grid=t.make("sidebar.creators.grid",this.data),this.sidebar.grid.append(this.grid),this.sidebar.breadcrumbsView.add(i.human_name,this,"showGridView"),t.registerEvents(this.grid,o,this),this.field},d.prototype.close=function(){this.data=null,this.grid=null,this.field=null},d.prototype.showFieldView=function(e){var n=new i(this.sidebar),s=t.data.find(this.data.fields,e),a=n.renderField(s);this.sidebar.breadcrumbsView.add(e,this,"showFieldView",[e]),this.data.field=s,this.field.empty(),this.field.append(a),this.field.show(),this.grid.hide(),this.sidebar.saveButton.show()},d.prototype.showGridView=function(){this.field.empty(),this.grid.show(),this.sidebar.saveButton.hide()},d.prototype.createDefaultFields=function(t){var i=[];e.each(t.types,function(n,s){i.push({id:n,mapping:n,model_type:t.model_type,type:s,values:e.extend({},t.defaults)})}),this.data.fields=i},d.prototype.save=function(t){this.data.fields.values=t;var i=this,n=this.data.page.url("create_model"),r={fields:this.data.fields,page:this.data.page.info};this.sidebar.layout.addClass("saving"),this.sidebar.validationErrors.empty(),e.ajax(n,{method:"POST",data:r,success:function(){s.apply(i,arguments)},error:function(){a.apply(i,arguments)}})},d.prototype.changed=function(e,t,i){this.data.field.values[e]=t},d}),devise.define("dvsGroupView",["jquery","dvsBaseView","dvsSelectSurrogate"],function(e,t,i){function n(e){var t=e.currentTarget.dataset.showNode,i=this.data.categories[this.showingCategoryIndex].nodes[t];this.showingNodeIndex=t,this.renderContentView(i)}function s(e){var t=parseInt(e.currentTarget.value);this.showingCategoryIndex!=t&&(this.showingCategoryIndex=t,this.sidebar.breadcrumbsView.back(0),this.renderCategorySelectorView())}var a={"click [data-show-node]":n,"change [data-category-selector]":s},r=function(e){this.sidebar=e,this.data={page:e.page},this.content=null,this.grid=null,this.categorySelector=null,this.contentView=null};return r.prototype.render=function(t){return this.data.node=t,this.data.categories=t.data.categories,this.content=e("<div/>"),this.sidebar.breadcrumbsView.add(t.human_name,this,"renderGridAndSelectorViews"),this.showingCategoryIndex=0,this.showingNodeIndex=!1,this.renderGridView(),this.renderCategorySelectorView(),this.content},r.prototype.renderGridAndSelectorViews=function(){this.renderGridView(),this.renderCategorySelectorView()},r.prototype.renderGridView=function(){for(var e=0;e<this.data.categories.length;e++)this.data.categories[e].active=!1;this.contentView&&this.contentView.close(),this.contentView=null,this.content.empty(),this.data.categories[this.showingCategoryIndex].active="dvs-active",this.grid=t.make("sidebar.groups.grid",this.data),this.sidebar.grid.empty(),this.sidebar.grid.append(this.grid),this.sidebar.saveButton.hide(),this.sidebar.manageCollection.empty(),this.sidebar.validationErrors.empty(),t.registerEvents(this.grid,a,this)},r.prototype.renderCategorySelectorView=function(){this.sidebar.groupSelector.empty(),this.data.categories.length<2||(this.categorySelector=t.make("sidebar.groups.selector",{showingCategoryIndex:this.showingCategoryIndex,categories:this.data.categories}),this.sidebar.groupSelector.append(this.categorySelector),i(),t.registerEvents(this.categorySelector,a,this))},r.prototype.renderContentView=function(e){this.contentView&&this.contentView.close(),this.sidebar.grid.empty(),this.contentView=this.sidebar.createViewFromBinding(e.binding),this.content.empty(),this.content.append(this.contentView.render(e))},r.prototype.close=function(){this.contentView&&this.contentView.close(),this.contentView=null,this.data=null,this.content=null,this.grid=null,this.categorySelector=null},r.prototype.save=function(e,t){this.contentView.save(e,t)},r.prototype.changed=function(e,t,i){this.contentView.changed(e,t,i)},r.prototype.contentRequestedChanged=function(e){"function"==typeof this.contentView.contentRequestedChanged&&this.contentView.contentRequestedChanged(e)},r.prototype.fieldScopeChanged=function(e){"function"==typeof this.contentView.fieldScopeChanged&&this.contentView.fieldScopeChanged(e)},r.prototype.resetValuesChanged=function(e){"function"==typeof this.contentView.resetValuesChanged&&this.contentView.resetValuesChanged(e)},r}),devise.define("dvsBreadCrumbsView",["jquery","dvsBaseView"],function(e,t){function i(e){var t=e.currentTarget.dataset.breadcrumbId;this.back(t)}var n={"click [data-breadcrumb-id]":i},s=function(){this.container=e("<div/>"),this.breadcrumbs=[]};return s.prototype.setContainerElement=function(e){this.container=e,t.registerEvents(this.container,n,this)},s.prototype.add=function(e,t,i,n){if("string"!=typeof e)throw"cannot add breadcrumb without name";if("object"!=typeof t)throw"cannot add breacrumb without context";if("string"!=typeof i)throw"cannot add breacrumb without back handler";"undefined"==typeof n&&(n=[]),this.breadcrumbs.length>0&&(this.breadcrumbs[this.breadcrumbs.length-1].last=!1),this.breadcrumbs.push({id:this.breadcrumbs.length,last:!0,name:e,handler:i,context:t,args:n}),this.container.empty(),this.container.append(this.render()),this.container.show(),this.breadcrumbs.length<2&&this.container.hide()},s.prototype.back=function(e){"undefined"==typeof e&&(e=this.breadcrumbs.length-2);var t=parseInt(e);if(isNaN(t)||t>this.breadcrumbs.length-1||0>t)throw"cannot go back to "+e;var i=this.breadcrumbs[t];i.context[i.handler].apply(i.context,i.args),this.breadcrumbs=this.breadcrumbs.splice(0,t+1),this.breadcrumbs[t].last=!0,this.container.empty(),this.container.append(this.render()),this.breadcrumbs.length<2&&this.container.hide()},s.prototype.render=function(){return t.make("sidebar.partials.breadcrumbs",{breadcrumbs:this.breadcrumbs})},s.prototype.show=function(){this.container.show()},s.prototype.hide=function(){this.container.hide()},s}),devise.define("dvsLiveUpdate",["jquery","query"],function(e,t){function i(e,t){var i=!1,n=e.model_type,s=e.model_id;for(var a in e.picks)if(e.picks[a]===t){i=a;break}return i?n+"-"+s+"-"+i:!1}function n(e,t){return e.originals?e.originals.scope+"-"+e.originals.id+"-"+t:e.scope+"-"+e.id+"-"+t}function s(e,t){return e.values[t]}var a=function(){this.iframe=e("<iframe />"),this.bindings=[],this.bindings.apply=function(){},this.bindings.get=function(e){},this.bindings.set=function(e,t){}};return a.prototype.setup=function(e,t,i){this.iframe=e,this.bindings=t,this.database=i},a.prototype.changedFieldAttribute=function(e,t){var i=n(e,t),a=s(e,t);this.bindings.set(i,a),this.bindings.apply(i)},a.prototype.changedField=function(e){for(var t in e.values)this.changedFieldAttribute(e,t)},a.prototype.changedModel=function(e){for(var t in e.values)this.changedModelAttribute(e,t)},a.prototype.changedModelAttribute=function(e,t){var n=i(e,t),a=s(e,t);n&&(this.bindings.set(n,a),this.bindings.apply(n))},a.prototype.setDefaultsForField=function(e){var t=this.getDefaultsForField(e);for(var i in t)"undefined"!=typeof e.values[i]&&e.values[i]||(e.values[i]=t[i])},a.prototype.getDefaultsForField=function(e){var t={},i=n(e,"");for(var s in this.database)if(s.match(i)){var a=s.replace(i,"");t[a]=this.database[s]}return t},a.prototype.refresh=function(){"undefined"!=typeof this.iframe[0]&&"undefined"!=typeof this.iframe[0].contentWindow&&"undefined"!=typeof this.iframe[0].contentWindow.location&&"undefined"!=typeof this.iframe[0].contentWindow.location.reload&&this.iframe[0].contentWindow.location.reload(!0)},a}),devise.define("AttributeBinding",[],function(){var e=function(e,t,i){this.node=e,this.key=t,this.lookup=i};return e.prototype.apply=function(){var e=this.lookup(this.key);this.old=this.node.nodeValue,this.node.nodeValue=e},e}),devise.define("ClassBinding",[],function(){var e=function(e,t,i,n){this.node=e,this.key=t,this.lookup=i,this.old=this.match,this.oldValues=[this.match]};return e.prototype.apply=function(){var e=this.lookup(this.key);if(e=e.replace(new RegExp(",","g"),""),""===e&&(e=this.match),e!==this.old){for(var t=e.split(" "),i=0;i<this.oldValues.length;i++)this.oldValues[i]&&this.node.classList.remove(this.oldValues[i]);for(var i=0;i<t.length;i++)t[i]&&this.node.classList.add(t[i]);this.old=e,this.oldValues=t}},e}),devise.define("StyleBinding",[],function(){function e(e,t,i){return e?i.replace(new RegExp(e,"g"),t):i}var t=function(e,t,i,n,s,a){this.node=e,this.key=t,this.match=n,this.lookup=i,this.style=s,this.value=a};return t.prototype.apply=function(){var t=this.lookup(this.key),i=e(this.match,t.toString(),this.value);t?this.node.style[this.style]=i:this.node.style[this.style]="inherit"},t}),devise.define("TextBinding",["jquery"],function(e){function t(t){if(!t||""===t)return[document.createTextNode("")];var i=[],n=[],s=e("<div/>");s.html(t),n=s[0].childNodes;for(var a=0;a<n.length;a++)i.push(n[a].cloneNode(!0));return i}var i=function(e,t,i,n){this.match=n,this.key=t,this.lookup=i,this.old=n,this.nodes=[e]};return i.prototype.apply=function(){var e=this.lookup(this.key);if(this.old!==e){this.parentNode||(this.parentNode=this.nodes[0].parentNode);for(var i=this.nodes[0],n=t(e),s=0;s<n.length;s++)this.parentNode.insertBefore(n[s],i);for(var s=0;s<this.nodes.length;s++)this.parentNode.removeChild(this.nodes[s]);this.old=e,this.nodes=n}},i})}(),devise.require(["jquery"],function(e){devise.$=e});